<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端票券待辦清單</title>
    
    <!-- 1. 引入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 Babel (讓瀏覽器看懂 React JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 設定 Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-[#F8FAFC]">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, setDoc, doc, onSnapshot, query, orderBy, serverTimestamp, getDocs, writeBatch } from 'firebase/firestore';
        import { Trash2, Calendar, QrCode, Check, Plus, LogIn, ExternalLink, Filter, ArrowUpDown, Tag, RotateCcw, CheckCircle2, ListTodo, Clock, Wifi, WifiOff, AlertTriangle, StickyNote, Save, X, ScanBarcode, Pencil, ClipboardPaste, ArrowRightLeft, Copy, CheckSquare, Trash, RefreshCcw, Search, FolderInput, FolderPlus, FolderX, Folder } from 'lucide-react';

        // 外部設定檔讀取
        const externalConfig = window.MY_FIREBASE_CONFIG || {};

        // Firebase 設定
        const firebaseConfig = externalConfig.apiKey ? externalConfig : {
            apiKey: "AIzaSyA1o7BjEcjZBEyjNKnVi5bknbkkJJSy0DI",
            authDomain: "task-71198.firebaseapp.com",
            projectId: "task-71198",
            storageBucket: "task-71198.firebasestorage.app",
            messagingSenderId: "192519078026",
            appId: "1:192519078026:web:b283a50108f54bbd6d6d73",
            measurementId: "G-29ZTR7DCJL"
        };

        let app, auth, db;
        try {
            if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (error) {
            console.error("Firebase Init Error", error);
        }

        const appId = 'my-ticket-app';
        const TAGS_DOC_ID = '__tags__'; // 儲存標籤列表的特殊文件 ID

        // Components: QRCode & Barcode
        const QRCodeImage = ({ text, size = 150 }) => {
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}`;
            return (
                <div className="flex flex-col items-center">
                    <span className="text-xs text-gray-400 mb-1">QR Code</span>
                    <img src={url} alt="QR Code" className="rounded-lg border p-2 bg-white shadow-sm" />
                </div>
            );
        };

        const BarcodeImage = ({ text }) => {
            const url = `https://bwipjs-api.metafloor.com/?bcid=code128&text=${encodeURIComponent(text)}&scale=2&includetext&backgroundcolor=ffffff&padding=10`;
            return (
                <div className="flex flex-col items-center w-full">
                    <span className="text-xs text-gray-400 mb-1">Barcode</span>
                    <img src={url} alt="Barcode" className="rounded-lg border p-2 bg-white shadow-sm max-w-full h-auto" />
                </div>
            );
        };

        // Utils
        const parseTicketInfo = (text) => {
            const result = { isTicket: false, serial: '', productName: '', expiry: '', originalText: text };
            const serialMatch = text.match(/(?:票券序號|序號)[:：]\s*([A-Za-z0-9]+)/);
            if (serialMatch) { result.isTicket = true; result.serial = serialMatch[1]; }
            
            const expiryLineMatch = text.match(/(?:兌換期限|優惠期限|期限)[:：]?\s*([^\n]*)/);
            if (expiryLineMatch) {
                const lineContent = expiryLineMatch[1];
                const dateMatches = lineContent.match(/\d{4}[\/\-]\d{2}[\/\-]\d{2}/g);
                if (dateMatches && dateMatches.length > 0) {
                    result.expiry = dateMatches[dateMatches.length - 1];
                }
            }

            const nameMatch = text.match(/【.*?】.*/);
            if (nameMatch) { result.productName = nameMatch[0]; }
            else if (result.isTicket) {
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                const likelyName = lines.find(l => l.includes('元') || l.includes('飲品') || l.includes('券') || l.includes('雞') || l.includes('堡') || l.includes('餐'));
                result.productName = likelyName || (lines[serialMatch ? lines.findIndex(l => l.includes('序號')) + 1 : 0] || "未命名票券");
            }
            if (result.isTicket && !result.productName) result.productName = "未命名票券";
            return result;
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
        };

        // Components
        const LoginScreen = ({ onJoin, authError }) => {
            const [code, setCode] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (code.trim().length > 0) onJoin(code.trim()); };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><LogIn className="text-blue-600 w-8 h-8" /></div>
                            <h1 className="text-2xl font-bold text-gray-800">票券小幫手</h1>
                            <p className="text-gray-500 mt-2">請輸入共用空間代碼以同步資料</p>
                        </div>
                        {authError && <div className="mb-4 p-4 bg-red-50 border border-red-100 rounded-lg text-left text-xs text-red-600">{authError}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">空間代碼 (Workspace ID)</label>
                                <input type="text" required placeholder="例如: my-tickets-2025" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" value={code} onChange={(e) => setCode(e.target.value)} />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">進入清單 <ExternalLink size={18} /></button>
                        </form>
                    </div>
                </div>
            );
        };

        const TaskItem = ({ task, onToggle, onDelete, onRestore, onPermanentDelete, onUpdateNote, onUpdateText, onUpdateTicket, isSelectionMode, isSelected, onSelect }) => {
            const [showCodes, setShowCodes] = useState(false);
            const isCompleted = task.completed;
            const isDeleted = task.isDeleted;
            const textClass = (isCompleted || isDeleted) ? 'text-gray-400 line-through' : 'text-gray-800';
            const completedDate = task.completedAt ? formatTimestamp(task.completedAt) : '';
            const [isEditingNote, setIsEditingNote] = useState(false);
            const [noteDraft, setNoteDraft] = useState(task.note || '');
            const [isEditingContent, setIsEditingContent] = useState(false);
            const [editName, setEditName] = useState(task.productName || task.text || '');
            const [editSerial, setEditSerial] = useState(task.serial || '');
            const [editExpiry, setEditExpiry] = useState(task.expiry || '');

            useEffect(() => { setNoteDraft(task.note || '') }, [task.note]);
            useEffect(() => { setEditName(task.productName || task.text || ''); setEditSerial(task.serial || ''); setEditExpiry(task.expiry || ''); }, [task]);

            const handleSaveNote = () => { onUpdateNote(task.id, noteDraft); setIsEditingNote(false); };
            const handleSaveContent = () => {
                if (task.isTicket) { onUpdateTicket(task.id, editName, editSerial, editExpiry); } 
                else { onUpdateText(task.id, editName); }
                setIsEditingContent(false);
            };

            const NoteSection = () => (
                <div className="w-full mt-2">
                    {isEditingNote ? (
                        <div className="flex flex-col gap-2 bg-yellow-50 p-2 rounded-lg border border-yellow-200 animate-in">
                            <textarea value={noteDraft} onChange={(e) => setNoteDraft(e.target.value)} placeholder="輸入備註..." className="w-full text-sm bg-transparent outline-none resize-none text-gray-700 min-h-[60px]" autoFocus />
                            <div className="flex justify-end gap-2"><button onClick={() => setIsEditingNote(false)}><X size={16}/></button><button onClick={handleSaveNote}><Save size={14}/> 儲存</button></div>
                        </div>
                    ) : (
                        task.note && <div onClick={() => setIsEditingNote(true)} className="bg-yellow-50 p-2 rounded-lg border border-yellow-100 text-sm text-gray-600 cursor-pointer flex items-start gap-2"><StickyNote size={14} className="mt-0.5 text-yellow-500 flex-shrink-0" /><span className="break-words whitespace-pre-wrap">{task.note}</span></div>
                    )}
                </div>
            );

            let containerStyle = `rounded-xl shadow-sm border p-4 mb-3 flex flex-col gap-2 hover:shadow-md transition-shadow group relative `;
            if (isDeleted) containerStyle += 'bg-red-50/50 border-red-100 opacity-80';
            else if (isCompleted) containerStyle += 'bg-gray-50/50 border-gray-200';
            else containerStyle += 'bg-white border-gray-100';
            if (isSelected) containerStyle += ' ring-2 ring-blue-400 border-blue-400';

            if (isEditingContent) {
                return (
                    <div className="bg-white rounded-xl shadow-sm border border-blue-200 p-4 mb-3 space-y-3">
                        {task.isTicket ? (
                            <>
                                <input type="text" value={editName} onChange={(e) => setEditName(e.target.value)} className="w-full border-b p-1 font-bold" placeholder="品名"/>
                                <div className="flex gap-2"><input type="text" value={editSerial} onChange={(e) => setEditSerial(e.target.value)} className="flex-1 bg-gray-50 p-2 rounded text-sm" placeholder="序號"/><input type="text" value={editExpiry} onChange={(e) => setEditExpiry(e.target.value)} className="w-1/3 bg-gray-50 p-2 rounded text-sm" placeholder="期限"/></div>
                            </>
                        ) : (<textarea value={editName} onChange={(e) => setEditName(e.target.value)} className="w-full border p-2 rounded" />)}
                        <div className="flex justify-end gap-2"><button onClick={() => setIsEditingContent(false)} className="text-sm text-gray-500">取消</button><button onClick={handleSaveContent} className="text-sm bg-blue-600 text-white px-3 py-1 rounded">儲存</button></div>
                    </div>
                );
            }

            return (
                <div className={containerStyle}>
                    <div className="flex items-start gap-3">
                        {isSelectionMode ? (
                            <div className="mt-1"><input type="checkbox" checked={isSelected} onChange={() => onSelect(task.id)} className="w-6 h-6 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"/></div>
                        ) : (
                            <button onClick={() => !isDeleted && onToggle(task)} disabled={isDeleted} className={`mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${isDeleted ? 'border-gray-300 text-gray-300' : isCompleted ? 'border-green-500 bg-green-500 text-white' : 'border-gray-300 text-transparent hover:border-blue-500 hover:text-blue-500'}`}>{isDeleted ? <Trash2 size={14} /> : (isCompleted ? <RotateCcw size={14} /> : <Check size={14} strokeWidth={3} />)}</button>
                        )}
                        <div className="flex-1 min-w-0">
                            {task.isTicket ? (
                                <div><div className="flex justify-between items-start flex-wrap gap-2"><h3 className={`font-bold text-lg leading-tight mb-1 ${textClass}`}>{task.productName}</h3>{task.expiry && <span className={`text-xs px-2 py-1 rounded-full font-medium whitespace-nowrap ${isCompleted || isDeleted ? 'bg-gray-200 text-gray-500' : 'bg-green-100 text-green-700'}`}>{task.expiry} 到期</span>}</div><div className={`text-sm font-mono inline-block px-2 py-0.5 rounded mt-1 border ${isCompleted || isDeleted ? 'bg-gray-100 text-gray-400' : 'bg-gray-50 text-gray-500'}`}>{task.serial}</div></div>
                            ) : (<div className={`break-words whitespace-pre-wrap ${textClass}`}>{task.text}</div>)}
                            
                            {/* 顯示標籤 */}
                            {task.tag && task.tag !== 'default' && (
                                <span className="inline-flex items-center gap-1 mt-1 px-2 py-0.5 rounded text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-100">
                                    <Tag size={10} /> {task.tag}
                                </span>
                            )}

                            <NoteSection />
                            {task.isTicket && <div className="mt-3 flex gap-2 items-center flex-wrap"><button onClick={() => setShowCodes(!showCodes)} className="flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors bg-blue-50 text-blue-600 hover:bg-blue-100"><ScanBarcode size={16} /> {showCodes ? '隱藏條碼' : '顯示條碼'}</button></div>}
                        </div>
                        <div className="flex flex-col gap-1 items-center">
                            {isDeleted ? (
                                <><button onClick={() => onRestore(task)} className="text-green-600 p-1" title="復原"><RefreshCcw size={18} /></button><button onClick={() => onPermanentDelete(task.id)} className="text-red-400 p-1" title="永久刪除"><Trash2 size={18} /></button></>
                            ) : (
                                <>{!isCompleted && <><button onClick={() => setIsEditingContent(true)} className="text-gray-400 hover:text-blue-600 p-1"><Pencil size={18} /></button>{!task.note && !isEditingNote && <button onClick={() => setIsEditingNote(true)} className="text-gray-400 hover:text-yellow-500 p-1"><StickyNote size={18} /></button>}</>}{!isSelectionMode && <button onClick={() => onDelete(task.id)} className="text-gray-300 hover:text-red-500 p-1"><Trash size={18} /></button>}</>
                            )}
                        </div>
                    </div>
                    {isCompleted && completedDate && <div className="pl-9 flex items-center"><span className="text-xs text-gray-400 flex items-center gap-1"><Clock size={10} /> {completedDate}</span></div>}
                    {task.isTicket && showCodes && <div className="bg-gray-50 p-4 border-t border-gray-100 flex flex-col items-center gap-6 mt-2"><BarcodeImage text={task.serial} /><QRCodeImage text={task.serial} size={150} /><div className="text-xs text-gray-400 font-mono tracking-widest">{task.serial}</div></div>}
                </div>
            );
        };

        const MigrationModal = ({ isOpen, onClose, currentSpaceId, onMigrate }) => {
            const [targetId, setTargetId] = useState('');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in">
                    <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                        <h2 className="text-xl font-bold mb-4">資料搬家 (複製)</h2>
                        <input type="text" value={targetId} onChange={(e) => setTargetId(e.target.value)} placeholder="目標空間代碼" className="w-full px-3 py-2 border rounded-lg mb-4" />
                        <div className="flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 text-gray-500">取消</button><button onClick={() => onMigrate(targetId)} disabled={!targetId.trim()} className="px-4 py-2 bg-blue-600 text-white rounded-lg">開始複製</button></div>
                    </div>
                </div>
            );
        };

        // --- Tag Manager Modal (Renaming + Adding) ---
        const TagManagerModal = ({ isOpen, onClose, tags, onAddTag, onDeleteTag, onRenameTag }) => {
            const [newTag, setNewTag] = useState('');
            const [editingTag, setEditingTag] = useState(null); // The tag currently being edited
            const [editValue, setEditValue] = useState(''); // The new name

            if (!isOpen) return null;

            const startEdit = (tag) => {
                setEditingTag(tag);
                setEditValue(tag);
            };

            const saveEdit = () => {
                if (editValue.trim() && editValue !== editingTag) {
                    onRenameTag(editingTag, editValue.trim());
                }
                setEditingTag(null);
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in">
                    <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6">
                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Tag size={20}/> 管理標籤</h2>
                        <div className="flex gap-2 mb-4">
                            <input type="text" value={newTag} onChange={(e) => setNewTag(e.target.value)} placeholder="新標籤名稱" className="flex-1 px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                            <button onClick={() => { if(newTag.trim()) { onAddTag(newTag.trim()); setNewTag(''); } }} className="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700"><Plus size={18}/></button>
                        </div>
                        <div className="max-h-60 overflow-y-auto space-y-2">
                            {tags.length === 0 ? <p className="text-gray-400 text-sm text-center py-4">尚無自訂標籤</p> : tags.map(tag => (
                                <div key={tag} className="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100">
                                    {editingTag === tag ? (
                                        <div className="flex gap-2 flex-1">
                                            <input type="text" value={editValue} onChange={(e) => setEditValue(e.target.value)} className="w-full border-b border-blue-500 outline-none text-sm" autoFocus />
                                            <button onClick={saveEdit} className="text-green-600 hover:text-green-700"><Check size={16}/></button>
                                            <button onClick={() => setEditingTag(null)} className="text-gray-400 hover:text-gray-600"><X size={16}/></button>
                                        </div>
                                    ) : (
                                        <>
                                            <span className="text-gray-700 font-medium">{tag}</span>
                                            <div className="flex gap-1">
                                                <button onClick={() => startEdit(tag)} className="text-gray-400 hover:text-blue-600 p-1"><Pencil size={14}/></button>
                                                <button onClick={() => { if(confirm(`確定刪除標籤「${tag}」嗎？`)) onDeleteTag(tag); }} className="text-red-400 hover:text-red-600 p-1"><X size={16}/></button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))}
                        </div>
                        <button onClick={onClose} className="w-full mt-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">關閉</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [workspaceId, setWorkspaceId] = useState(() => localStorage.getItem('ticket_workspace_id') || '');
            const [tasks, setTasks] = useState([]);
            const [inputMode, setInputMode] = useState('paste'); 
            const [pasteVal, setPasteVal] = useState('');
            const [manualName, setManualName] = useState('');
            const [manualSerial, setManualSerial] = useState('');
            const [manualExpiry, setManualExpiry] = useState('');
            const [isJoined, setIsJoined] = useState(false);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState('');
            
            // Persisted States
            const [viewStatus, setViewStatus] = useState('active');
            const [filterType, setFilterType] = useState(() => localStorage.getItem('pref_filterType') || 'all');
            const [sortType, setSortType] = useState(() => localStorage.getItem('pref_sortType') || 'newest');
            const [currentTagFilter, setCurrentTagFilter] = useState(() => localStorage.getItem('pref_tagFilter') || 'all');

            // New Features State
            const [tags, setTags] = useState([]); // List of custom tags strings
            const [searchQuery, setSearchQuery] = useState('');
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedTasks, setSelectedTasks] = useState(new Set());
            const [showTagManager, setShowTagManager] = useState(false);
            const [showMigration, setShowMigration] = useState(false);
            const [isMigrating, setIsMigrating] = useState(false);

            // Save Prefs
            useEffect(() => { localStorage.setItem('pref_filterType', filterType); }, [filterType]);
            useEffect(() => { localStorage.setItem('pref_sortType', sortType); }, [sortType]);
            useEffect(() => { localStorage.setItem('pref_tagFilter', currentTagFilter); }, [currentTagFilter]);

            useEffect(() => {
                const initAuth = async () => {
                    if (!auth) return;
                    try { await signInAnonymously(auth); } catch (e) { setAuthError(e.message); }
                };
                initAuth();
                if (auth) {
                    const unsubscribe = onAuthStateChanged(auth, (u) => {
                        setUser(u); if (u) setAuthError(''); if (workspaceId) setIsJoined(true);
                    });
                    return () => unsubscribe();
                } else { setLoading(false); }
            }, []);

            // Data Sync (Tasks) - Keep existing ordering logic for tasks
            useEffect(() => {
                if (!user || !workspaceId || !db) { setLoading(false); return; }
                setLoading(true);
                // 讀取任務 (過濾掉 tags 檔案)
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', workspaceId), orderBy('createdAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const loadedTasks = [];
                    snapshot.docs.forEach(doc => {
                        if (doc.id !== TAGS_DOC_ID) {
                            loadedTasks.push({ id: doc.id, ...doc.data() });
                        }
                    });
                    setTasks(loadedTasks);
                    setLoading(false);
                }, (error) => { console.error("Fetch Tasks error:", error); setLoading(false); });
                return () => unsubscribe();
            }, [user, workspaceId]);

            // Data Sync (Tags) - Separate Listener
            useEffect(() => {
                if (!user || !workspaceId || !db) return;
                const tagDocRef = doc(db, 'artifacts', appId, 'public', 'data', workspaceId, TAGS_DOC_ID);
                const unsubscribeTags = onSnapshot(tagDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setTags(docSnap.data().list || []);
                    } else {
                        setTags([]); // Initialize empty if doc doesn't exist
                    }
                }, (error) => { console.error("Fetch Tags error:", error); });
                return () => unsubscribeTags();
            }, [user, workspaceId]);

            // --- Logic: Processed Tasks (Filters & Search) ---
            const processedTasks = useMemo(() => {
                let result = [...tasks];
                
                // 1. Status Filter
                if (viewStatus === 'active') result = result.filter(t => !t.completed && !t.isDeleted);
                else if (viewStatus === 'completed') result = result.filter(t => t.completed && !t.isDeleted);
                else if (viewStatus === 'deleted') result = result.filter(t => t.isDeleted);

                // 2. Type Filter
                if (filterType === 'ticket') result = result.filter(t => t.isTicket);
                else if (filterType === 'normal') result = result.filter(t => !t.isTicket);

                // 3. Tag Filter
                if (currentTagFilter !== 'all') {
                    if (currentTagFilter === 'uncategorized') {
                        result = result.filter(t => !t.tag || t.tag === 'default');
                    } else {
                        result = result.filter(t => t.tag === currentTagFilter);
                    }
                }

                // 4. Search Filter
                if (searchQuery.trim()) {
                    const q = searchQuery.toLowerCase();
                    result = result.filter(t => 
                        (t.productName || '').toLowerCase().includes(q) || 
                        (t.text || '').toLowerCase().includes(q) ||
                        (t.serial || '').toLowerCase().includes(q) ||
                        (t.note || '').toLowerCase().includes(q)
                    );
                }

                // 5. Sort
                if (sortType === 'expiring') result.sort((a, b) => { if (a.expiry && b.expiry) return new Date(a.expiry) - new Date(b.expiry); if (a.expiry) return -1; if (b.expiry) return 1; return 0; });
                else if (sortType === 'oldest') result.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                else result.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                return result;
            }, [tasks, viewStatus, filterType, sortType, currentTagFilter, searchQuery]);

            const handleJoin = (id) => { setWorkspaceId(id); localStorage.setItem('ticket_workspace_id', id); setIsJoined(true); };

            const handleAddTask = async () => {
                if (!user) return;
                let newTask = {};
                const currentTagToSave = (currentTagFilter !== 'all' && currentTagFilter !== 'uncategorized') ? currentTagFilter : 'default';

                if (inputMode === 'paste') {
                    if (!pasteVal.trim()) return;
                    const parsed = parseTicketInfo(pasteVal);
                    newTask = { 
                        text: pasteVal, isTicket: parsed.isTicket, serial: parsed.serial, productName: parsed.productName, expiry: parsed.expiry, 
                        completed: false, isDeleted: false, createdAt: serverTimestamp(), note: '', tag: currentTagToSave
                    };
                } else {
                    if (!manualName.trim()) return;
                    const fmtExpiry = manualExpiry ? manualExpiry.replace(/-/g, '/') : '';
                    newTask = {
                        text: manualName, isTicket: !!manualSerial.trim(), serial: manualSerial.trim(), productName: manualName, expiry: fmtExpiry, 
                        completed: false, isDeleted: false, createdAt: serverTimestamp(), note: '', tag: currentTagToSave
                    };
                }

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', workspaceId), newTask);
                    setPasteVal(''); setManualName(''); setManualSerial(''); setManualExpiry('');
                    if (viewStatus !== 'active') setViewStatus('active');
                } catch (e) { alert(`新增失敗：${e.message}`); }
            };

            // Basic Actions
            const handleToggleComplete = async (task) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, task.id), { completed: !task.completed, completedAt: !task.completed ? serverTimestamp() : null }); };
            const handleUpdateNote = async (id, newNote) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { note: newNote }); };
            const handleUpdateText = async (id, newText) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { text: newText, productName: newText }); };
            const handleUpdateTicket = async (id, name, serial, expiry) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { productName: name, serial: serial, expiry: expiry }); };
            const handleDelete = async (id) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { isDeleted: true, deletedAt: serverTimestamp() }); };
            const handleRestore = async (task) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, task.id), { isDeleted: false, completed: false }); };
            const handlePermanentDelete = async (id) => { if (!user) return; if(confirm("確定永久刪除？")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id)); };
            const handleLogout = () => { localStorage.removeItem('ticket_workspace_id'); setWorkspaceId(''); setIsJoined(false); setTasks([]); };

            // Tag Management
            const handleAddTag = async (newTag) => {
                if (!user || tags.includes(newTag)) return;
                const updatedTags = [...tags, newTag];
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, TAGS_DOC_ID), { list: updatedTags }, { merge: true });
            };
            const handleDeleteTag = async (tagToDelete) => {
                if (!user) return;
                const updatedTags = tags.filter(t => t !== tagToDelete);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, TAGS_DOC_ID), { list: updatedTags }, { merge: true });
                // Reset tasks with this tag to default
                const tasksToUpdate = tasks.filter(t => t.tag === tagToDelete);
                const batch = writeBatch(db);
                tasksToUpdate.forEach(t => {
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, t.id), { tag: 'default' });
                });
                await batch.commit();
                if (currentTagFilter === tagToDelete) setCurrentTagFilter('all');
            };
            const handleRenameTag = async (oldTag, newTag) => {
                if (!user || !newTag.trim() || newTag === oldTag || tags.includes(newTag)) return;
                const updatedTags = tags.map(t => t === oldTag ? newTag : t);
                const batch = writeBatch(db);
                // 1. Update tag list
                const tagDocRef = doc(db, 'artifacts', appId, 'public', 'data', workspaceId, TAGS_DOC_ID);
                batch.set(tagDocRef, { list: updatedTags }, { merge: true });
                // 2. Update all tasks
                const tasksToUpdate = tasks.filter(t => t.tag === oldTag);
                tasksToUpdate.forEach(t => {
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, t.id), { tag: newTag });
                });
                await batch.commit();
                if (currentTagFilter === oldTag) setCurrentTagFilter(newTag);
            };

            // Batch Operations
            const handleSelect = (id) => {
                const newSet = new Set(selectedTasks);
                if (newSet.has(id)) newSet.delete(id); else newSet.add(id);
                setSelectedTasks(newSet);
            };
            const handleSelectAll = () => {
                if (selectedTasks.size === processedTasks.length && processedTasks.length > 0) {
                    setSelectedTasks(new Set()); // Deselect all
                } else {
                    const newSet = new Set();
                    processedTasks.forEach(t => newSet.add(t.id));
                    setSelectedTasks(newSet);
                }
            };
            
            const handleBatchMoveTag = async (targetTag) => {
                if (!user || selectedTasks.size === 0) return;
                const batch = writeBatch(db);
                selectedTasks.forEach(id => {
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { tag: targetTag });
                });
                await batch.commit();
                setIsSelectionMode(false); setSelectedTasks(new Set());
            };

            const handleBatchDelete = async () => {
                if (!user || selectedTasks.size === 0) return;
                if (!confirm(`確定將 ${selectedTasks.size} 個項目移至垃圾桶？`)) return;
                const batch = writeBatch(db);
                selectedTasks.forEach(id => batch.update(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { isDeleted: true }));
                await batch.commit();
                setIsSelectionMode(false); setSelectedTasks(new Set());
            };

            const handleEmptyTrash = async () => {
                if (!user) return;
                const trashItems = tasks.filter(t => t.isDeleted);
                if (trashItems.length === 0) return;
                if (!confirm(`⚠️ 警告：確定清空垃圾桶中的 ${trashItems.length} 個項目嗎？此動作無法復原！`)) return;
                
                const batch = writeBatch(db);
                trashItems.forEach(t => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, t.id)));
                await batch.commit();
            };

            const handleMigrate = async (targetId) => {
                if (!targetId || targetId === workspaceId) return;
                setIsMigrating(true);
                try {
                    const sourceRef = collection(db, 'artifacts', appId, 'public', 'data', workspaceId);
                    const snapshot = await getDocs(sourceRef);
                    if (snapshot.empty) { alert("目前空間沒有資料"); setIsMigrating(false); return; }
                    const chunks = []; let batch = writeBatch(db); let count = 0;
                    snapshot.docs.forEach((docSnap) => {
                        const data = docSnap.data();
                        const newRef = doc(collection(db, 'artifacts', appId, 'public', 'data', targetId));
                        batch.set(newRef, data);
                        count++;
                        if (count >= 400) { chunks.push(batch); batch = writeBatch(db); count = 0; }
                    });
                    if (count > 0) chunks.push(batch);
                    await Promise.all(chunks.map(b => b.commit()));
                    if (confirm(`成功搬移到「${targetId}」！是否切換？`)) { handleJoin(targetId); }
                    setShowMigration(false);
                } catch (e) { alert("搬移失敗：" + e.message); } finally { setIsMigrating(false); }
            };

            if (!auth && !firebaseConfig.apiKey) return <div className="min-h-screen flex items-center justify-center"><p>尚未設定 Config</p></div>;
            if (!isJoined) return <LoginScreen onJoin={handleJoin} authError={authError} />;

            return (
                <div className="min-h-screen bg-[#F8FAFC] text-gray-800 font-sans pb-24">
                    {/* Header */}
                    <div className="bg-white sticky top-0 z-10 shadow-sm border-b border-gray-100">
                        <div className="max-w-3xl mx-auto px-4 py-3">
                            <div className="flex items-center justify-between mb-3">
                                <div className="flex items-center gap-2">
                                    <div className="bg-blue-600 text-white p-1.5 rounded-lg"><Calendar size={20} /></div>
                                    <div>
                                        <h1 className="font-bold text-lg leading-none">票券記事本</h1>
                                        <p className="text-xs text-gray-400 mt-0.5 font-mono">ID: {workspaceId}</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowMigration(true)} className="text-sm text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 flex items-center gap-1"><ArrowRightLeft size={14} /> 搬家</button>
                                    <button onClick={handleLogout} className="text-sm text-gray-500 hover:text-red-500 px-2 py-1 rounded hover:bg-gray-50">切換</button>
                                </div>
                            </div>
                            
                            {/* Search & Tag Bar */}
                            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                <div className="relative flex-1 min-w-[150px]">
                                    <Search size={16} className="absolute left-2 top-2 text-gray-400" />
                                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="搜尋關鍵字..." className="w-full pl-8 pr-2 py-1.5 text-sm bg-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                                    {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-2 top-2 text-gray-400 hover:text-gray-600"><X size={14}/></button>}
                                </div>
                                <button onClick={() => setCurrentTagFilter('all')} className={`px-3 py-1.5 rounded-lg text-sm whitespace-nowrap transition-colors ${currentTagFilter === 'all' ? 'bg-gray-800 text-white' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'}`}>全部</button>
                                {tags.map(tag => (
                                    <button key={tag} onClick={() => setCurrentTagFilter(tag)} className={`px-3 py-1.5 rounded-lg text-sm whitespace-nowrap transition-colors flex items-center gap-1 ${currentTagFilter === tag ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'}`}>
                                        <Tag size={12} /> {tag}
                                    </button>
                                ))}
                                <button onClick={() => setCurrentTagFilter('uncategorized')} className={`px-3 py-1.5 rounded-lg text-sm whitespace-nowrap transition-colors ${currentTagFilter === 'uncategorized' ? 'bg-gray-600 text-white' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'}`}>未分類</button>
                                <button onClick={() => setShowTagManager(true)} className="px-2 py-1.5 rounded-lg text-sm text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-100 whitespace-nowrap flex items-center gap-1"><FolderPlus size={14}/> 管理</button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto px-4 py-4">
                        {/* Input Area */}
                        {viewStatus === 'active' && (
                            <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 mb-4 transition-all focus-within:ring-2 focus-within:ring-blue-100">
                                <div className="flex justify-between mb-2">
                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">新增項目到: {currentTagFilter === 'all' || currentTagFilter === 'uncategorized' ? '未分類' : currentTagFilter}</span>
                                    <button onClick={() => setInputMode(inputMode === 'paste' ? 'manual' : 'paste')} className="text-xs flex items-center gap-1 text-blue-600 hover:text-blue-700 bg-blue-50 px-2 py-1 rounded transition-colors">{inputMode === 'paste' ? <Pencil size={12}/> : <ClipboardPaste size={12}/>} {inputMode === 'paste' ? '手動' : '貼上'}</button>
                                </div>
                                {inputMode === 'paste' ? (
                                    <textarea value={pasteVal} onChange={(e) => setPasteVal(e.target.value)} placeholder="貼上票券內容..." className="w-full text-base resize-none outline-none text-gray-700 placeholder:text-gray-400 min-h-[60px]" rows={3} />
                                ) : (
                                    <div className="space-y-3">
                                        <div><input type="text" value={manualName} onChange={(e) => setManualName(e.target.value)} placeholder="輸入內容 (必填)" className="w-full border-b pb-1 outline-none" /></div>
                                        <div className="flex gap-2"><input type="text" value={manualSerial} onChange={(e) => setManualSerial(e.target.value)} placeholder="序號 (選填)" className="flex-1 bg-gray-50 p-2 rounded text-sm" /><input type="date" value={manualExpiry} onChange={(e) => setManualExpiry(e.target.value)} className="w-1/3 bg-gray-50 p-2 rounded text-sm" /></div>
                                    </div>
                                )}
                                <div className="flex justify-end mt-2"><button onClick={handleAddTask} disabled={inputMode === 'paste' ? !pasteVal.trim() : !manualName.trim()} className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-1"><Plus size={16}/> 新增</button></div>
                            </div>
                        )}

                        {/* View Tabs */}
                        <div className="flex gap-4 mb-4 border-b border-gray-200">
                            <button onClick={() => setViewStatus('active')} className={`pb-2 px-1 text-base font-medium flex items-center gap-2 border-b-2 ${viewStatus === 'active' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500'}`}><ListTodo size={18} /> 待辦 <span className="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full">{tasks.filter(t => !t.completed && !t.isDeleted).length}</span></button>
                            <button onClick={() => setViewStatus('completed')} className={`pb-2 px-1 text-base font-medium flex items-center gap-2 border-b-2 ${viewStatus === 'completed' ? 'border-green-600 text-green-600' : 'border-transparent text-gray-500'}`}><CheckCircle2 size={18} /> 已完成 <span className="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full">{tasks.filter(t => t.completed && !t.isDeleted).length}</span></button>
                            <button onClick={() => setViewStatus('deleted')} className={`pb-2 px-1 text-base font-medium flex items-center gap-2 border-b-2 ${viewStatus === 'deleted' ? 'border-red-600 text-red-600' : 'border-transparent text-gray-500'}`}><Trash size={18} /> 垃圾桶 <span className="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full">{tasks.filter(t => t.isDeleted).length}</span></button>
                        </div>

                        {/* Operations Bar */}
                        <div className="flex flex-col sm:flex-row gap-3 mb-4 justify-between items-center bg-white p-2 rounded-xl border border-gray-200 shadow-sm">
                            <div className="flex items-center gap-2 w-full sm:w-auto">
                                <button onClick={() => { setIsSelectionMode(!isSelectionMode); setSelectedTasks(new Set()); }} className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-1 ${isSelectionMode ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                    <CheckSquare size={16}/> {isSelectionMode ? '結束多選' : '多選'}
                                </button>
                                {isSelectionMode && (
                                    <>
                                        <button onClick={handleSelectAll} className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-md text-sm hover:bg-gray-200">
                                            {selectedTasks.size === processedTasks.length && processedTasks.length > 0 ? '取消全選' : '全選'}
                                        </button>
                                        <div className="h-6 w-px bg-gray-300 mx-1"></div>
                                        {/* Batch Actions */}
                                        {selectedTasks.size > 0 && (
                                            <div className="flex gap-2 animate-in fade-in zoom-in duration-200">
                                                {viewStatus !== 'deleted' && (
                                                    <select 
                                                        onChange={(e) => { if(e.target.value) handleBatchMoveTag(e.target.value); }} 
                                                        className="bg-indigo-50 text-indigo-700 text-sm px-2 py-1.5 rounded-md border-indigo-100 focus:ring-2 focus:ring-indigo-500 outline-none"
                                                        value=""
                                                    >
                                                        <option value="" disabled>移動到...</option>
                                                        <option value="default">未分類</option>
                                                        {tags.map(t => <option key={t} value={t}>{t}</option>)}
                                                    </select>
                                                )}
                                                <button onClick={handleBatchDelete} className="px-3 py-1.5 bg-red-100 text-red-700 rounded-md text-sm hover:bg-red-200 flex items-center gap-1"><Trash size={14}/> 刪除</button>
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                            
                            {/* Empty Trash Button */}
                            {viewStatus === 'deleted' && !isSelectionMode && tasks.some(t => t.isDeleted) && (
                                <button onClick={handleEmptyTrash} className="ml-auto px-3 py-1.5 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 flex items-center gap-1 shadow-sm">
                                    <Trash2 size={16}/> 清空垃圾桶
                                </button>
                            )}

                            {!isSelectionMode && (
                                <div className="flex gap-2 ml-auto">
                                    <div className="flex gap-1 bg-gray-100 p-1 rounded-lg">
                                        <button onClick={() => setFilterType('all')} className={`px-2 py-1 rounded text-xs ${filterType === 'all' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>全部</button>
                                        <button onClick={() => setFilterType('ticket')} className={`px-2 py-1 rounded text-xs ${filterType === 'ticket' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>票券</button>
                                        <button onClick={() => setFilterType('normal')} className={`px-2 py-1 rounded text-xs ${filterType === 'normal' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>一般</button>
                                    </div>
                                    <select value={sortType} onChange={(e) => setSortType(e.target.value)} className="bg-gray-50 border text-gray-700 text-xs rounded-lg p-1.5"><option value="newest">最新</option><option value="expiring">快到期</option><option value="oldest">最早</option></select>
                                </div>
                            )}
                        </div>

                        {/* List */}
                        {loading ? <div className="flex justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div> : (
                            <div className="space-y-2">
                                <div className="flex items-center justify-between px-1 mb-2">
                                    <h2 className="text-xs font-bold text-gray-400 uppercase tracking-wider">
                                        {viewStatus === 'active' ? '待辦清單' : (viewStatus === 'completed' ? '已完成項目' : '垃圾桶')} • {processedTasks.length} 筆
                                        {isSelectionMode && <span className="text-blue-600 ml-2">(已選 {selectedTasks.size})</span>}
                                    </h2>
                                </div>
                                {processedTasks.length === 0 ? <div className="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300 text-gray-400">沒有符合的項目</div> : 
                                    processedTasks.map(task => <TaskItem key={task.id} task={task} onToggle={handleToggleComplete} onDelete={handleDelete} onRestore={handleRestore} onPermanentDelete={handlePermanentDelete} onUpdateNote={handleUpdateNote} onUpdateText={handleUpdateText} onUpdateTicket={handleUpdateTicket} isSelectionMode={isSelectionMode} isSelected={selectedTasks.has(task.id)} onSelect={handleSelect} />)
                                }
                            </div>
                        )}
                    </div>

                    {viewStatus === 'active' && <div className="fixed bottom-6 right-6 md:hidden"><button onClick={() => document.querySelector('textarea')?.focus()} className="bg-blue-600 text-white p-4 rounded-full shadow-lg shadow-blue-600/30 hover:bg-blue-700 transition-all active:scale-95"><Plus size={24} /></button></div>}
                    
                    {/* Modals */}
                    <TagManagerModal isOpen={showTagManager} onClose={() => setShowTagManager(false)} tags={tags} onAddTag={handleAddTag} onDeleteTag={handleDeleteTag} onRenameTag={handleRenameTag} />
                    {showMigration && <MigrationModal isOpen={showMigration} onClose={() => setShowMigration(false)} currentSpaceId={workspaceId} onMigrate={handleMigrate}/>}
                    {isMigrating && <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center"><div className="bg-white p-6 rounded-xl flex flex-col items-center gap-4"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div><p className="font-bold text-gray-700">處理中...</p></div></div>}
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
