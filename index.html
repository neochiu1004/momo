<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端票券待辦清單 (Pro+)</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 引入本地繪製條碼與QR Code的函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- 4. 設定 Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        secondary: '#475569',
                    }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        canvas { max-width: 100%; height: auto; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, setDoc, doc, onSnapshot, query, orderBy, serverTimestamp, getDocs, writeBatch } from 'firebase/firestore';
        import { 
            Trash2, Calendar, Check, Plus, LogIn, ExternalLink, Tag, RotateCcw, 
            CheckCircle2, ListTodo, Clock, StickyNote, Save, X, ScanBarcode, 
            Pencil, ClipboardPaste, ArrowRightLeft, Copy, CheckSquare, Trash, 
            RefreshCcw, Search, FolderPlus, AlertCircle, MoreVertical, Copy as CopyIcon, Link as LinkIcon,
            Image as ImageIcon, Upload, Clipboard, ClipboardList
        } from 'lucide-react';

        // --- Firebase Configuration ---
        const externalConfig = window.MY_FIREBASE_CONFIG || {};
        const firebaseConfig = externalConfig.apiKey ? externalConfig : {
            apiKey: "AIzaSyA1o7BjEcjZBEyjNKnVi5bknbkkJJSy0DI",
            authDomain: "task-71198.firebaseapp.com",
            projectId: "task-71198",
            storageBucket: "task-71198.firebasestorage.app",
            messagingSenderId: "192519078026",
            appId: "1:192519078026:web:b283a50108f54bbd6d6d73",
            measurementId: "G-29ZTR7DCJL"
        };

        let app, auth, db;
        try {
            if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (error) {
            console.error("Firebase Init Error", error);
        }

        const appId = 'my-ticket-app';
        const TAGS_DOC_ID = 'app_tags';

        // --- Image Compression Utility ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const MAX_WIDTH = 800; 
                        const MAX_HEIGHT = 800;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- Canvas Generators ---
        const QRCodeCanvas = ({ text, size = 150 }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current && window.QRious) {
                    new window.QRious({
                        element: canvasRef.current,
                        value: text,
                        size: size,
                        level: 'H'
                    });
                }
            }, [text, size]);
            return (
                <div className="flex flex-col items-center p-2 bg-white rounded-lg border shadow-sm">
                    <span className="text-[10px] text-gray-400 mb-1 uppercase tracking-wider">QR Code</span>
                    <canvas ref={canvasRef} />
                </div>
            );
        };

        const BarcodeCanvas = ({ text }) => {
            const canvasRef = useRef(null);
            const [error, setError] = useState(false);
            useEffect(() => {
                if (canvasRef.current && window.bwipjs) {
                    try {
                        window.bwipjs.toCanvas(canvasRef.current, {
                            bcid: 'code128', text: text, scale: 3, height: 10, includetext: true, textxalign: 'center',
                        });
                        setError(false);
                    } catch (e) { console.error(e); setError(true); }
                }
            }, [text]);
            if (error) return <div className="text-xs text-red-400">無法產生條碼</div>;
            return (
                <div className="flex flex-col items-center w-full p-2 bg-white rounded-lg border shadow-sm">
                    <span className="text-[10px] text-gray-400 mb-1 uppercase tracking-wider">Barcode (Code128)</span>
                    <canvas ref={canvasRef} className="max-w-full h-auto" />
                </div>
            );
        };

        // --- Utilities ---
        const parseTicketInfo = (text) => {
            const result = { isTicket: false, serial: '', productName: '', expiry: '', originalText: text };
            const serialMatch = text.match(/(?:票券序號|序號|CODE|Code)[:：]\s*([A-Za-z0-9]+)/i);
            if (serialMatch) { result.isTicket = true; result.serial = serialMatch[1]; }
            
            const dateRegex = /\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/g;
            const dateMatches = text.match(dateRegex);
            if (dateMatches && dateMatches.length > 0) result.expiry = dateMatches[dateMatches.length - 1];

            const nameMatch = text.match(/【.*?】.*/);
            if (nameMatch) { result.productName = nameMatch[0]; }
            else if (result.isTicket) {
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                const likelyName = lines.find(l => l.length > 2 && l.length < 20 && !l.includes('序號') && !l.includes('期限') && !l.match(/\d{4}/) && (l.includes('元') || l.includes('券') || l.includes('飲') || l.includes('餐') || l.includes('堡') || l.includes('咖啡')));
                result.productName = likelyName || (lines[0] || "未命名票券");
            }
            if (result.isTicket && !result.productName) result.productName = "未命名票券";
            return result;
        };

        const formatTimestamp = (timestamp, includeTime = false) => {
            if (!timestamp) return '';
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            const dateStr = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            if (includeTime) {
                return `${dateStr} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            }
            return dateStr;
        };

        const checkIsExpiringSoon = (expiryStr, thresholdDays) => {
            if (!expiryStr) return false;
            const normalizedDate = expiryStr.replace(/[\.\-]/g, '/');
            const expiryDate = new Date(normalizedDate);
            if (isNaN(expiryDate.getTime())) return false;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const diffTime = expiryDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= thresholdDays;
        };
        
        const copyToClipboard = async (text) => {
            if (!text) return false;
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return successful;
                } catch (fallbackErr) {
                    console.error('Failed to copy:', fallbackErr);
                    return false;
                }
            }
        };

        // --- Components ---
        const LoginScreen = ({ onJoin, authError }) => {
            const [code, setCode] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (code.trim().length > 0) onJoin(code.trim()); };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 px-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 transform rotate-3 shadow-blue-100 shadow-lg"><Calendar className="text-blue-600 w-10 h-10" /></div>
                            <h1 className="text-3xl font-extrabold text-slate-800 mb-2">票券小幫手 <span className="text-blue-600">Pro+</span></h1>
                            <p className="text-slate-500">雲端同步 · 隱私保護 · 到期提醒</p>
                        </div>
                        {authError && <div className="mb-6 p-4 bg-red-50 border border-red-100 rounded-xl text-sm text-red-600 flex items-center gap-2"><AlertCircle size={16}/> {authError}</div>}
                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2 ml-1">空間代碼 (Workspace ID)</label>
                                <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><LogIn className="h-5 w-5 text-gray-400" /></div><input type="text" required placeholder="例如: 2025-tickets" className="w-full pl-10 pr-4 py-3.5 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none font-medium" value={code} onChange={(e) => setCode(e.target.value)} /></div>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 active:scale-[0.98] text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-blue-600/20 flex items-center justify-center gap-2">進入清單 <ExternalLink size={18} /></button>
                        </form>
                    </div>
                </div>
            );
        };

        const TaskItem = ({ task, onToggle, onDelete, onRestore, onPermanentDelete, onUpdateNote, onUpdateText, onUpdateTicket, isSelectionMode, isSelected, onSelect, expiryThreshold }) => {
            const [showCodes, setShowCodes] = useState(false);
            const [justCopied, setJustCopied] = useState(false);
            const isCompleted = task.completed;
            const isDeleted = task.isDeleted;
            const completedDate = task.completedAt ? formatTimestamp(task.completedAt, true) : ''; // Include time
            const createdDate = task.createdAt ? formatTimestamp(task.createdAt, true) : ''; // Include time
            const [isEditingContent, setIsEditingContent] = useState(false);
            
            // Edit states
            const [editName, setEditName] = useState(task.productName || task.text || '');
            const [editSerial, setEditSerial] = useState(task.serial || '');
            const [editExpiry, setEditExpiry] = useState(task.expiry || '');
            const [editImage, setEditImage] = useState(task.image || '');
            const [editUrl, setEditUrl] = useState(task.url || '');
            const [editNote, setEditNote] = useState(task.note || '');

            useEffect(() => { 
                setEditName(task.productName || task.text || ''); 
                setEditSerial(task.serial || ''); 
                setEditExpiry(task.expiry || '');
                setEditImage(task.image || '');
                setEditUrl(task.url || '');
                setEditNote(task.note || '');
            }, [task]);

            const handleSaveContent = () => {
                onUpdateTicket(task.id, editName, editSerial, editExpiry, editImage, editUrl, editNote);
                setIsEditingContent(false);
            };

            const handleCopySerial = async (e) => {
                e.stopPropagation();
                if (task.serial) {
                    const success = await copyToClipboard(task.serial);
                    if (success) {
                        setJustCopied(true);
                        setTimeout(() => setJustCopied(false), 2000);
                    } else {
                        alert("複製失敗，請手動複製");
                    }
                }
            };
            
            const handleEditImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const compressed = await compressImage(file);
                    setEditImage(compressed);
                } catch (err) { alert("圖片處理失敗"); }
            };

            const isExpiring = !isCompleted && !isDeleted && task.expiry && checkIsExpiringSoon(task.expiry, expiryThreshold);
            
            let containerStyle = `rounded-2xl border p-4 mb-3 transition-all duration-200 relative overflow-hidden `;
            if (isDeleted) containerStyle += 'bg-red-50/40 border-red-100';
            else if (isCompleted) containerStyle += 'bg-slate-50 border-slate-200';
            else if (isExpiring) containerStyle += 'bg-white border-red-200 shadow-[0_0_0_1px_rgba(239,68,68,0.2)] shadow-sm';
            else containerStyle += 'bg-white border-slate-100 hover:border-blue-200 shadow-sm hover:shadow-md';
            
            if (isSelected) containerStyle += ' ring-2 ring-blue-500 border-blue-500 bg-blue-50/30';

            const NoteSection = () => (
                <div className="w-full mt-2">
                    {task.note && (
                        <div onClick={(e) => { if(!isDeleted) { e.stopPropagation(); setIsEditingContent(true); }}} className={`bg-amber-50/60 p-2.5 rounded-lg border border-amber-100/50 text-sm text-slate-600 flex items-start gap-2 ${!isDeleted && 'cursor-pointer hover:bg-amber-50'}`}>
                            <StickyNote size={14} className="mt-0.5 text-amber-400 flex-shrink-0" />
                            <span className="break-words whitespace-pre-wrap leading-relaxed">{task.note}</span>
                        </div>
                    )}
                </div>
            );

            if (isEditingContent) {
                return (
                    <div className="bg-white rounded-2xl shadow-lg border border-blue-500 p-4 mb-3 space-y-3 ring-4 ring-blue-500/10 z-10 relative animate-in" onClick={(e) => e.stopPropagation()}>
                        <label className="block text-xs font-bold text-gray-400">品名 / 內容</label>
                        <input type="text" value={editName} onChange={(e) => setEditName(e.target.value)} className="w-full border-b border-gray-200 focus:border-blue-500 pb-1 font-bold text-lg outline-none" placeholder="品名"/>
                        <div className="flex items-start gap-3 p-2 bg-slate-50 rounded-lg border border-slate-100">
                            {editImage ? (
                                <div className="relative w-16 h-16 flex-shrink-0">
                                    <img src={editImage} alt="Preview" className="w-full h-full object-cover rounded-md" />
                                    <button onClick={() => setEditImage('')} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 shadow-sm hover:bg-red-600"><X size={12}/></button>
                                </div>
                            ) : (
                                <div className="w-16 h-16 bg-slate-200 rounded-md flex items-center justify-center text-slate-400"><ImageIcon size={24} /></div>
                            )}
                            <div className="flex-1">
                                <label className="block text-xs font-bold text-gray-400 mb-1">圖片</label>
                                <input type="file" accept="image/*" onChange={handleEditImageUpload} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                            <div className="col-span-2">
                                <label className="block text-xs font-bold text-gray-400 mb-1">序號</label>
                                <input type="text" value={editSerial} onChange={(e) => setEditSerial(e.target.value)} className="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm font-mono" placeholder="序號"/>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-400 mb-1">期限</label>
                                <input type="text" value={editExpiry} onChange={(e) => setEditExpiry(e.target.value)} className="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm" placeholder="YYYY/MM/DD"/>
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-400 mb-1">URL 連結</label>
                            <input type="url" value={editUrl} onChange={(e) => setEditUrl(e.target.value)} className="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm" placeholder="https://..."/>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-400 mb-1">備註</label>
                            <textarea value={editNote} onChange={(e) => setEditNote(e.target.value)} className="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm resize-none h-20" placeholder="備註..."/>
                        </div>
                        <div className="flex justify-end gap-2 pt-2 border-t border-slate-100">
                            <button onClick={() => setIsEditingContent(false)} className="text-sm text-slate-500 hover:text-slate-700 px-3 py-1.5">取消</button>
                            <button onClick={handleSaveContent} className="text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg shadow-sm">儲存變更</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className={containerStyle}>
                    {isExpiring && <div className="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-bl-lg font-bold flex items-center gap-1 shadow-sm"><Clock size={10} /> 即將到期</div>}
                    <div className="flex items-start gap-3.5">
                        <div className="mt-1 flex-shrink-0">
                            {isSelectionMode ? (
                                <div className="w-6 h-6 flex items-center justify-center">
                                    <input type="checkbox" checked={isSelected} onChange={() => onSelect(task.id)} className="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" />
                                </div>
                            ) : (
                                <button onClick={(e) => { e.stopPropagation(); !isDeleted && onToggle(task); }} disabled={isDeleted} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 ${isDeleted ? 'border-slate-300 text-slate-400 bg-slate-100 cursor-not-allowed' : isCompleted ? 'border-green-500 bg-green-500 text-white scale-105 shadow-sm' : 'border-slate-300 text-transparent hover:border-blue-500 hover:text-blue-500'}`}>{isDeleted ? <Trash2 size={12} /> : (isCompleted ? <Check size={14} strokeWidth={3} /> : <Check size={14} strokeWidth={3} />)}</button>
                            )}
                        </div>
                        <div className="flex-1 min-w-0" onClick={() => setShowCodes(!showCodes)}>
                            <div className="cursor-pointer">
                                <div>
                                    <div className="flex flex-wrap items-start gap-2 mb-1 pr-6">
                                        <h3 className={`font-bold text-lg leading-snug flex-1 ${isCompleted || isDeleted ? 'text-slate-500 line-through decoration-slate-300' : 'text-slate-800'}`}>{task.productName}</h3>
                                        {task.image && <div className="w-12 h-12 rounded-lg border border-slate-100 overflow-hidden flex-shrink-0 bg-white"><img src={task.image} alt="Thumbnail" className={`w-full h-full object-cover ${isDeleted && 'grayscale'}`} /></div>}
                                        {task.url && <a href={task.url} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded-full p-1 transition-colors mt-0.5" title="開啟連結"><ExternalLink size={16} /></a>}
                                    </div>
                                    <div className="flex flex-wrap items-center gap-2 mb-2">
                                        {task.serial && <div onClick={(e) => !isDeleted && handleCopySerial(e)} className={`group flex items-center gap-1.5 text-sm font-mono px-2 py-1 rounded border transition-colors ${justCopied ? 'bg-green-50 border-green-200 text-green-700' : (isCompleted || isDeleted ? 'bg-slate-100 border-slate-200 text-slate-400' : 'bg-slate-50 border-slate-200 text-slate-600 hover:border-blue-300 hover:text-blue-600 cursor-pointer active:scale-95')}`}>{task.serial}{!isDeleted && (justCopied ? <Check size={12} /> : <CopyIcon size={12} className="opacity-50 group-hover:opacity-100"/>)}</div>}
                                        {task.expiry && <span className={`text-xs px-2 py-1 rounded-md font-medium flex items-center gap-1 ${isCompleted || isDeleted ? 'bg-slate-100 text-slate-400' : (isExpiring ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-green-50 text-green-700 border border-green-100')}`}><Calendar size={10} /> {task.expiry}</span>}
                                    </div>
                                    {!task.isTicket && task.text !== task.productName && <div className={`text-sm mb-2 line-clamp-2 ${isCompleted || isDeleted ? 'text-slate-400' : 'text-slate-600'}`}>{task.text}</div>}
                                </div>
                            </div>
                            {task.tag && task.tag !== 'default' && <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-indigo-50 text-indigo-600 border border-indigo-100 mb-1"><Tag size={10} /> {task.tag}</span>}
                            <NoteSection />
                            {task.isTicket && !isDeleted && <div className="mt-3 flex gap-2"><button onClick={(e) => { e.stopPropagation(); setShowCodes(!showCodes); }} className={`flex-1 sm:flex-none flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${showCodes ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}><ScanBarcode size={14} /> {showCodes ? '收起詳情' : '顯示詳情'}</button></div>}
                            {isDeleted && <div className="mt-2 text-xs text-red-400 flex items-center gap-1"><Trash2 size={12}/> 已在垃圾桶 - 點擊卡片可展開查看</div>}
                        </div>
                        {/* Quick Actions (Right Side) */}
                        <div className="flex flex-col gap-1">
                             {isDeleted ? (
                                <>
                                    <button onClick={(e) => { e.stopPropagation(); onRestore(task); }} className="p-2 text-green-600 bg-white border border-green-200 hover:bg-green-50 rounded-lg shadow-sm" title="還原"><RefreshCcw size={16} /></button>
                                    <button onClick={(e) => { e.stopPropagation(); onPermanentDelete(task.id); }} className="p-2 text-red-400 bg-white border border-red-200 hover:bg-red-50 rounded-lg shadow-sm" title="永久刪除"><Trash2 size={16} /></button>
                                </>
                            ) : (
                                <>
                                    {!isCompleted && !isSelectionMode && (
                                        <button onClick={(e) => { e.stopPropagation(); setIsEditingContent(true); }} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"><Pencil size={16} /></button>
                                    )}
                                    {isCompleted && !isSelectionMode && (
                                        <button onClick={(e) => { e.stopPropagation(); onToggle(task); }} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg" title="復原為待辦"><RotateCcw size={16} /></button>
                                    )}
                                    {!isSelectionMode && (
                                        <button onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg"><Trash size={16} /></button>
                                    )}
                                </>
                            )}
                        </div>
                    </div>
                    {/* Time display: Completed time for completed items, Created time for active/others */}
                    {isCompleted && completedDate ? (
                        <div className="ml-10 mt-2 text-[10px] text-slate-400 flex items-center gap-1"><Clock size={10} /> 完成於 {completedDate}</div>
                    ) : (
                        createdDate && <div className="ml-10 mt-2 text-[10px] text-slate-300 flex items-center gap-1">新增於 {createdDate}</div>
                    )}
                    
                    {showCodes && (
                        <div className="mt-4 pt-6 border-t border-dashed border-slate-200 animate-in cursor-default" onClick={(e) => e.stopPropagation()}>
                            <div className="bg-white p-6 rounded-2xl flex flex-col items-center gap-5 text-center shadow-sm border border-slate-100 relative">
                                <button onClick={() => setShowCodes(false)} className="absolute top-2 right-2 text-slate-300 hover:text-slate-500"><X size={20}/></button>
                                <h3 className="text-xl font-bold text-slate-800 leading-tight">{task.productName}</h3>
                                {task.image && <div className="w-full max-w-[240px] rounded-xl overflow-hidden shadow-sm border border-slate-100"><img src={task.image} alt="Product" className={`w-full h-auto object-contain bg-slate-50 ${isDeleted && 'grayscale opacity-75'}`} /></div>}
                                {task.isTicket && (
                                    <>
                                        <div className="w-full h-px bg-slate-100 my-1"></div>
                                        <div className="w-full max-w-[280px] opacity-90"><BarcodeCanvas text={task.serial} /></div>
                                        <div className="w-full max-w-[200px] opacity-90"><QRCodeCanvas text={task.serial} /></div>
                                        <div className="font-mono text-xl font-bold tracking-widest text-slate-700 bg-slate-50 px-6 py-2 rounded-lg border border-slate-200 select-all">{task.serial}</div>
                                    </>
                                )}
                                {task.note && <p className="text-sm text-slate-500 bg-amber-50 p-2 rounded w-full text-left">{task.note}</p>}
                                {task.url && <a href={task.url} target="_blank" className="text-blue-600 underline text-sm break-all">{task.url}</a>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TagManagerModal = ({ isOpen, onClose, tags, onAddTag, onDeleteTag, onRenameTag }) => {
            const [newTag, setNewTag] = useState('');
            const [editingTag, setEditingTag] = useState(null); 
            const [editValue, setEditValue] = useState(''); 
            if (!isOpen) return null;
            const startEdit = (tag) => { setEditingTag(tag); setEditValue(tag); };
            const saveEdit = () => { if (editValue.trim() && editValue !== editingTag) { onRenameTag(editingTag, editValue.trim()); } setEditingTag(null); };
            return (
                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 border border-slate-100">
                        <div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold flex items-center gap-2"><FolderPlus size={20} className="text-blue-600"/> 管理標籤</h2><button onClick={onClose}><X size={20} className="text-slate-400 hover:text-slate-600"/></button></div>
                        <div className="flex gap-2 mb-4"><input type="text" value={newTag} onChange={(e) => setNewTag(e.target.value)} placeholder="新標籤名稱" className="flex-1 px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-sm" /><button onClick={() => { if(newTag.trim()) { onAddTag(newTag.trim()); setNewTag(''); } }} className="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700"><Plus size={18}/></button></div>
                        <div className="max-h-[300px] overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                            {tags.length === 0 ? <p className="text-slate-400 text-sm text-center py-8">尚無自訂標籤</p> : tags.map(tag => (
                                <div key={tag} className="flex justify-between items-center bg-slate-50 p-2.5 rounded-lg border border-slate-100 group">
                                    {editingTag === tag ? (
                                        <div className="flex gap-2 flex-1 items-center"><input type="text" value={editValue} onChange={(e) => setEditValue(e.target.value)} className="flex-1 bg-white px-2 py-1 rounded border border-blue-300 outline-none text-sm" autoFocus /><button onClick={saveEdit} className="text-green-600 hover:bg-green-50 p-1 rounded"><Check size={16}/></button><button onClick={() => setEditingTag(null)} className="text-slate-400 hover:bg-slate-100 p-1 rounded"><X size={16}/></button></div>
                                    ) : (
                                        <><span className="text-slate-700 font-medium text-sm pl-1">{tag}</span><div className="flex gap-1"><button onClick={() => startEdit(tag)} className="text-slate-400 hover:text-blue-600 p-1.5 hover:bg-blue-50 rounded"><Pencil size={14}/></button><button onClick={() => { if(confirm(`確定刪除標籤「${tag}」嗎？`)) onDeleteTag(tag); }} className="text-slate-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded"><Trash2 size={14}/></button></div></>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const MigrationModal = ({ isOpen, onClose, currentSpaceId, onMigrate }) => {
            const [targetId, setTargetId] = useState('');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in">
                    <div className="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
                        <h2 className="text-xl font-bold mb-2">資料搬家 (複製)</h2>
                        <p className="text-sm text-slate-500 mb-4">將目前空間的所有資料複製到另一個空間 ID。</p>
                        <input type="text" value={targetId} onChange={(e) => setTargetId(e.target.value)} placeholder="輸入目標空間代碼" className="w-full px-4 py-3 border rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none" />
                        <div className="flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg">取消</button><button onClick={() => onMigrate(targetId)} disabled={!targetId.trim()} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white rounded-lg font-medium">開始複製</button></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [workspaceId, setWorkspaceId] = useState(() => localStorage.getItem('ticket_workspace_id') || '');
            const [tasks, setTasks] = useState([]);
            const [inputMode, setInputMode] = useState('paste'); 
            const [pasteVal, setPasteVal] = useState('');
            const [manualName, setManualName] = useState('');
            const [manualSerial, setManualSerial] = useState('');
            const [manualExpiry, setManualExpiry] = useState('');
            const [manualNote, setManualNote] = useState('');
            const [manualUrl, setManualUrl] = useState('');
            const [pendingImage, setPendingImage] = useState(''); 
            const [isJoined, setIsJoined] = useState(false);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState('');
            const fileInputRef = useRef(null);
            
            const [viewStatus, setViewStatus] = useState('active');
            const [filterType, setFilterType] = useState(() => localStorage.getItem('pref_filterType') || 'all');
            const [sortType, setSortType] = useState(() => localStorage.getItem('pref_sortType') || 'newest');
            const [currentTagFilter, setCurrentTagFilter] = useState(() => localStorage.getItem('pref_tagFilter') || 'all');
            const [expiryThreshold, setExpiryThreshold] = useState(() => parseInt(localStorage.getItem('pref_expiryThreshold') || '30'));

            const [tags, setTags] = useState([]); 
            const [searchQuery, setSearchQuery] = useState('');
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedTasks, setSelectedTasks] = useState(new Set());
            const [showTagManager, setShowTagManager] = useState(false);
            const [showMigration, setShowMigration] = useState(false);
            const [isMigrating, setIsMigrating] = useState(false);

            useEffect(() => { localStorage.setItem('pref_filterType', filterType); }, [filterType]);
            useEffect(() => { localStorage.setItem('pref_sortType', sortType); }, [sortType]);
            useEffect(() => { localStorage.setItem('pref_tagFilter', currentTagFilter); }, [currentTagFilter]);
            useEffect(() => { localStorage.setItem('pref_expiryThreshold', expiryThreshold); }, [expiryThreshold]);

            useEffect(() => {
                const initAuth = async () => { if (!auth) return; try { await signInAnonymously(auth); } catch (e) { setAuthError(e.message); } };
                initAuth();
                if (auth) { const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); if (u) setAuthError(''); if (workspaceId) setIsJoined(true); }); return () => unsubscribe(); } else { setLoading(false); }
            }, []);

            useEffect(() => {
                if (!user || !workspaceId || !db) { setLoading(false); return; }
                setLoading(true);
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', workspaceId), orderBy('createdAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const loadedTasks = [];
                    snapshot.docs.forEach(doc => { if (doc.id !== TAGS_DOC_ID) loadedTasks.push({ id: doc.id, ...doc.data() }); });
                    setTasks(loadedTasks);
                    setLoading(false);
                }, (error) => { console.error("Fetch Tasks error:", error); setLoading(false); });
                return () => unsubscribe();
            }, [user, workspaceId]);

            useEffect(() => {
                if (!user || !workspaceId || !db) return;
                const tagDocRef = doc(db, 'artifacts', appId, 'public', 'data', workspaceId, TAGS_DOC_ID);
                const unsubscribeTags = onSnapshot(tagDocRef, (docSnap) => { if (docSnap.exists()) setTags(docSnap.data().list || []); else setTags([]); }, (error) => console.error("Fetch Tags error:", error));
                return () => unsubscribeTags();
            }, [user, workspaceId]);

            const processedTasks = useMemo(() => {
                let result = [...tasks];
                if (viewStatus === 'active') result = result.filter(t => !t.completed && !t.isDeleted);
                else if (viewStatus === 'completed') result = result.filter(t => t.completed && !t.isDeleted);
                else if (viewStatus === 'deleted') result = result.filter(t => t.isDeleted);

                if (filterType === 'ticket') result = result.filter(t => t.isTicket);
                else if (filterType === 'normal') result = result.filter(t => !t.isTicket);

                if (currentTagFilter !== 'all') {
                    if (currentTagFilter === 'uncategorized') result = result.filter(t => !t.tag || t.tag === 'default');
                    else result = result.filter(t => t.tag === currentTagFilter);
                }

                if (searchQuery.trim()) {
                    const q = searchQuery.toLowerCase();
                    result = result.filter(t => {
                        const commonMatch = (t.productName || '').toLowerCase().includes(q) || (t.serial || '').toLowerCase().includes(q) || (t.note || '').toLowerCase().includes(q);
                        if (t.isTicket) return commonMatch;
                        return commonMatch || (t.text || '').toLowerCase().includes(q);
                    });
                }

                if (sortType === 'expiring') result.sort((a, b) => { if (a.expiry && b.expiry) return new Date(a.expiry.replace(/[\.\-]/g, '/')) - new Date(b.expiry.replace(/[\.\-]/g, '/')); if (a.expiry) return -1; if (b.expiry) return 1; return 0; });
                else if (sortType === 'oldest') result.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                else result.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                return result;
            }, [tasks, viewStatus, filterType, sortType, currentTagFilter, searchQuery]);

            const handleJoin = (id) => { setWorkspaceId(id); localStorage.setItem('ticket_workspace_id', id); setIsJoined(true); };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try { const compressed = await compressImage(file); setPendingImage(compressed); } catch (err) { alert("圖片處理失敗：" + err); }
                e.target.value = null;
            };

            const handlePasteFromClipboard = async () => {
                try {
                    const clipboardItems = await navigator.clipboard.read();
                    let foundImage = false;
                    for (const item of clipboardItems) {
                        const imageTypes = item.types.filter(type => type.startsWith('image/'));
                        for (const type of imageTypes) {
                            const blob = await item.getType(type);
                            const compressed = await compressImage(blob);
                            setPendingImage(compressed);
                            foundImage = true; break; 
                        }
                        if (foundImage) break;
                    }
                    if (!foundImage) alert("剪貼簿中沒有發現圖片");
                } catch (err) { 
                    // Improved error handling
                    console.error("Native paste failed:", err); 
                    setInputMode('paste'); // Force switch to paste mode
                    setTimeout(() => {
                        alert("⚠️ 瀏覽器安全限制：\n無法透過按鈕直接讀取。\n\n請直接點擊「輸入框」，並使用「貼上」功能 (Ctrl+V 或長按貼上)。\n系統會自動抓取剪貼簿中的文字與圖片。");
                        document.querySelector('textarea')?.focus();
                    }, 100);
                }
            };

            const handleSmartPaste = async () => {
                try {
                    const clipboardItems = await navigator.clipboard.read();
                    let foundAny = false;

                    for (const item of clipboardItems) {
                        const imageTypes = item.types.filter(type => type.startsWith('image/'));
                        if (imageTypes.length > 0) {
                            const blob = await item.getType(imageTypes[0]);
                            const compressed = await compressImage(blob);
                            setPendingImage(compressed);
                            foundAny = true;
                        }
                        
                        // New: Check for HTML type which might contain images (web copy)
                        else if (item.types.includes('text/html')) {
                             const blob = await item.getType('text/html');
                             const html = await blob.text();
                             const parser = new DOMParser();
                             const doc = parser.parseFromString(html, 'text/html');
                             const img = doc.querySelector('img');
                             if (img && img.src) {
                                 // Simple logic to prefer pendingImage if found.
                                 // Note: Handling external CORS images client-side is tricky, but data-uris work fine.
                                 // We set it as pending. If it fails to load later, user can replace.
                                 setPendingImage(img.src);
                                 foundAny = true;
                             }
                        }

                        if (item.types.includes('text/plain')) {
                            const blob = await item.getType('text/plain');
                            const text = await blob.text();
                            if (text) {
                                setPasteVal(prev => prev + (prev ? '\n' : '') + text);
                                setInputMode('paste');
                                foundAny = true;
                            }
                        }
                    }

                    if (!foundAny) {
                        // Fallback to text only
                        try {
                            const text = await navigator.clipboard.readText();
                            if (text) {
                                setPasteVal(prev => prev + (prev ? '\n' : '') + text);
                                setInputMode('paste');
                            } else {
                                alert("剪貼簿是空的");
                            }
                        } catch (e) {
                            throw e; // Trigger outer catch
                        }
                    }
                } catch (err) {
                    console.warn("Smart paste blocked:", err);
                    setInputMode('paste'); // Switch mode so user can see textarea
                    setTimeout(() => {
                        // Friendly user guide instead of error
                        alert("⚠️ 瀏覽器安全限制：\n\n請直接點擊下方的「輸入框」，然後使用「貼上」(Ctrl+V 或長按貼上)。\n\n系統會自動辨識剪貼簿中的文字與圖片！");
                        document.querySelector('textarea')?.focus();
                    }, 100);
                }
            };

            const handlePaste = async (e) => {
                const items = e.clipboardData.items;
                let hasFile = false;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault(); 
                        hasFile = true;
                        const blob = items[i].getAsFile();
                        try {
                            const compressed = await compressImage(blob);
                            setPendingImage(compressed);
                        } catch (err) {
                            console.error("Paste image error:", err);
                        }
                        return; 
                    }
                }

                if (!hasFile) {
                    const html = e.clipboardData.getData('text/html');
                    if (html) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const img = doc.querySelector('img');
                        if (img && img.src) {
                            if (img.src.startsWith('http') || img.src.startsWith('data:')) {
                                setPendingImage(img.src);
                            }
                        }
                    }
                }
            };

            const handleAddTask = async () => {
                if (!user) return;
                let newTask = {};
                const currentTagToSave = (currentTagFilter !== 'all' && currentTagFilter !== 'uncategorized') ? currentTagFilter : 'default';
                if (inputMode === 'paste') {
                    if (!pasteVal.trim() && !pendingImage) return;
                    const parsed = parseTicketInfo(pasteVal);
                    const name = parsed.productName || (pendingImage ? "圖片項目" : "未命名");
                    newTask = { text: pasteVal, isTicket: parsed.isTicket || !!pendingImage, serial: parsed.serial, productName: name, expiry: parsed.expiry, completed: false, isDeleted: false, createdAt: serverTimestamp(), note: '', url: '', tag: currentTagToSave, image: pendingImage };
                } else {
                    if (!manualName.trim() && !pendingImage) return;
                    const fmtExpiry = manualExpiry ? manualExpiry.replace(/-/g, '/') : '';
                    newTask = { text: manualName, isTicket: (!!manualSerial.trim() || !!pendingImage), serial: manualSerial.trim(), productName: manualName || "圖片項目", expiry: fmtExpiry, completed: false, isDeleted: false, createdAt: serverTimestamp(), note: manualNote, url: manualUrl, tag: currentTagToSave, image: pendingImage };
                }
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', workspaceId), newTask);
                    setPasteVal(''); setManualName(''); setManualSerial(''); setManualExpiry(''); setManualNote(''); setManualUrl(''); setPendingImage('');
                    if (viewStatus !== 'active') setViewStatus('active');
                } catch (e) { alert(`新增失敗：${e.message}`); }
            };

            const handleToggleComplete = async (task) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, task.id), { completed: !task.completed, completedAt: !task.completed ? serverTimestamp() : null }); };
            const handleUpdateNote = async (id, newNote) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { note: newNote }); };
            const handleUpdateText = async (id, newText) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { text: newText, productName: newText }); };
            const handleUpdateTicket = async (id, name, serial, expiry, image, url, note) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { productName: name, serial: serial, expiry: expiry, image: image, url: url, note: note }); };
            const handleDelete = async (id) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { isDeleted: true, deletedAt: serverTimestamp() }); };
            const handleRestore = async (task) => { if (!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, task.id), { isDeleted: false, completed: false }); };
            const handlePermanentDelete = async (id) => { if (!user) return; if(confirm("確定永久刪除？此動作無法復原。")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id)); };
            const handleLogout = () => { localStorage.removeItem('ticket_workspace_id'); setWorkspaceId(''); setIsJoined(false); setTasks([]); };

            const handleAddTag = async (newTag) => { if (!user || tags.includes(newTag)) return; try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, TAGS_DOC_ID), { list: [...tags, newTag] }, { merge: true }); } catch (e) { console.error("Add tag error:", e); } };
            const handleDeleteTag = async (tagToDelete) => { if (!user) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, TAGS_DOC_ID), { list: tags.filter(t => t !== tagToDelete) }, { merge: true }); const batch = writeBatch(db); tasks.filter(t => t.tag === tagToDelete).forEach(t => batch.update(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, t.id), { tag: 'default' })); await batch.commit(); if (currentTagFilter === tagToDelete) setCurrentTagFilter('all'); };
            const handleRenameTag = async (oldTag, newTag) => { if (!user || !newTag.trim() || newTag === oldTag || tags.includes(newTag)) return; const batch = writeBatch(db); batch.set(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, TAGS_DOC_ID), { list: tags.map(t => t === oldTag ? newTag : t) }, { merge: true }); tasks.filter(t => t.tag === oldTag).forEach(t => batch.update(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, t.id), { tag: newTag })); await batch.commit(); if (currentTagFilter === oldTag) setCurrentTagFilter(newTag); };

            const handleSelect = (id) => { const newSet = new Set(selectedTasks); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedTasks(newSet); };
            const handleSelectAll = () => { if (selectedTasks.size === processedTasks.length && processedTasks.length > 0) setSelectedTasks(new Set()); else { const newSet = new Set(); processedTasks.forEach(t => newSet.add(t.id)); setSelectedTasks(newSet); } };
            const handleBatchMoveTag = async (targetTag) => { if (!user || selectedTasks.size === 0) return; const batch = writeBatch(db); selectedTasks.forEach(id => batch.update(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { tag: targetTag })); await batch.commit(); setIsSelectionMode(false); setSelectedTasks(new Set()); };
            const handleBatchDelete = async () => { if (!user || selectedTasks.size === 0) return; if (!confirm(`確定將 ${selectedTasks.size} 個項目移至垃圾桶？`)) return; const batch = writeBatch(db); selectedTasks.forEach(id => batch.update(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, id), { isDeleted: true })); await batch.commit(); setIsSelectionMode(false); setSelectedTasks(new Set()); };
            const handleEmptyTrash = async () => { if (!user) return; const trashItems = tasks.filter(t => t.isDeleted); if (trashItems.length === 0) return; if (!confirm(`⚠️ 警告：確定清空垃圾桶中的 ${trashItems.length} 個項目嗎？此動作無法復原！`)) return; const batch = writeBatch(db); trashItems.forEach(t => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', workspaceId, t.id))); await batch.commit(); };
            const handleMigrate = async (targetId) => { if (!targetId || targetId === workspaceId) return; setIsMigrating(true); try { const sourceRef = collection(db, 'artifacts', appId, 'public', 'data', workspaceId); const snapshot = await getDocs(sourceRef); if (snapshot.empty) { alert("目前空間沒有資料"); setIsMigrating(false); return; } const chunks = []; let batch = writeBatch(db); let count = 0; snapshot.docs.forEach((docSnap) => { const data = docSnap.data(); const newRef = doc(collection(db, 'artifacts', appId, 'public', 'data', targetId)); batch.set(newRef, data); count++; if (count >= 400) { chunks.push(batch); batch = writeBatch(db); count = 0; } }); if (count > 0) chunks.push(batch); await Promise.all(chunks.map(b => b.commit())); if (confirm(`成功搬移到「${targetId}」！是否切換？`)) { handleJoin(targetId); } setShowMigration(false); } catch (e) { alert("搬移失敗：" + e.message); } finally { setIsMigrating(false); } };

            if (!auth && !firebaseConfig.apiKey) return <div className="min-h-screen flex items-center justify-center text-slate-500">尚未設定 Config</div>;
            if (!isJoined) return <LoginScreen onJoin={handleJoin} authError={authError} />;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-24">
                    <div className="bg-white sticky top-0 z-20 shadow-sm border-b border-slate-100">
                        <div className="max-w-3xl mx-auto px-4 py-3">
                            <div className="flex items-center justify-between mb-3">
                                <div className="flex items-center gap-3"><div className="bg-blue-600 text-white p-2 rounded-xl shadow-blue-200 shadow-md"><Calendar size={20} /></div><div><h1 className="font-extrabold text-lg leading-none tracking-tight text-slate-800">票券小幫手 <span className="text-blue-600">Pro+</span></h1><p className="text-[10px] text-slate-400 mt-1 font-mono tracking-wide bg-slate-100 px-1.5 py-0.5 rounded inline-block">ID: {workspaceId}</p></div></div>
                                <div className="flex items-center gap-2"><div className="relative group"><button className="p-2 hover:bg-slate-100 rounded-full text-slate-400"><MoreVertical size={20}/></button><div className="absolute right-0 top-full mt-1 bg-white border border-slate-100 rounded-xl shadow-xl p-1 min-w-[140px] hidden group-hover:block hover:block z-30"><button onClick={() => setShowMigration(true)} className="w-full text-left px-3 py-2 text-sm text-slate-600 hover:bg-blue-50 hover:text-blue-600 rounded-lg flex items-center gap-2"><ArrowRightLeft size={16} /> 資料搬家</button><button onClick={handleLogout} className="w-full text-left px-3 py-2 text-sm text-slate-600 hover:bg-red-50 hover:text-red-600 rounded-lg flex items-center gap-2"><LogIn size={16} className="rotate-180"/> 登出/切換</button></div></div></div>
                            </div>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 items-center">
                                <div className="relative flex-1 min-w-[140px] max-w-[200px]"><Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="搜尋..." className="w-full pl-9 pr-2 py-1.5 text-sm bg-slate-100 border-transparent focus:bg-white focus:border-blue-300 focus:ring-2 focus:ring-blue-100 rounded-lg outline-none transition-all" />{searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"><X size={12}/></button>}</div>
                                <div className="h-6 w-px bg-slate-200 mx-1 flex-shrink-0"></div><button onClick={() => setCurrentTagFilter('all')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition-colors border ${currentTagFilter === 'all' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>全部</button>{tags.map(tag => (<button key={tag} onClick={() => setCurrentTagFilter(tag)} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1 border ${currentTagFilter === tag ? 'bg-indigo-600 text-white border-indigo-600 shadow-md shadow-indigo-200' : 'bg-white border-slate-200 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600'}`}><Tag size={10} /> {tag}</button>))}
                            </div>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto px-4 py-4">
                        <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-1 bg-amber-50 px-2 py-1 rounded-md border border-amber-100"><Clock size={12} className="text-amber-500" /> <span className="text-[10px] text-amber-700 font-medium">到期提示</span><select value={expiryThreshold} onChange={(e) => setExpiryThreshold(parseInt(e.target.value))} className="bg-transparent outline-none font-bold text-amber-800 text-[10px] border-b border-amber-300"><option value="7">7天內</option><option value="14">14天內</option><option value="30">30天內</option><option value="60">60天內</option><option value="90">90天內</option></select></div></div>

                        {viewStatus === 'active' && (
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-6 transition-all focus-within:ring-4 focus-within:ring-blue-50 focus-within:border-blue-300 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                                <div className="flex justify-between mb-3 items-center pl-2"><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1"><Plus size={10}/> 新增到: {currentTagFilter === 'all' || currentTagFilter === 'uncategorized' ? '未分類' : currentTagFilter}</span><div className="flex bg-slate-100 p-0.5 rounded-lg"><button onClick={() => setInputMode('paste')} className={`px-2 py-1 rounded-md text-[10px] flex items-center gap-1 transition-all ${inputMode === 'paste' ? 'bg-white shadow text-blue-600 font-bold' : 'text-slate-500'}`}><ClipboardPaste size={10}/> 貼上</button><button onClick={() => setInputMode('manual')} className={`px-2 py-1 rounded-md text-[10px] flex items-center gap-1 transition-all ${inputMode === 'manual' ? 'bg-white shadow text-blue-600 font-bold' : 'text-slate-500'}`}><Pencil size={10}/> 手動</button></div></div>
                                {inputMode === 'paste' ? (<div onPaste={handlePaste} className="relative"><textarea value={pasteVal} onChange={(e) => setPasteVal(e.target.value)} placeholder="直接貼上簡訊、票券文字或「Ctrl+V 貼上圖片」..." className="w-full text-base resize-none outline-none text-slate-700 placeholder:text-slate-300 min-h-[80px] pl-2" /></div>) : (<div className="space-y-3 pl-2" onPaste={handlePaste}><div><input type="text" value={manualName} onChange={(e) => setManualName(e.target.value)} placeholder="內容/品名 (必填)" className="w-full border-b border-slate-200 pb-2 outline-none font-medium focus:border-blue-500 transition-colors" /></div><div className="flex gap-2"><input type="text" value={manualSerial} onChange={(e) => setManualSerial(e.target.value)} placeholder="序號 (選填)" className="flex-1 bg-slate-50 p-2.5 rounded-lg text-sm border-transparent focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition-all" /><input type="text" value={manualExpiry} onChange={(e) => setManualExpiry(e.target.value)} placeholder="YYYY/MM/DD" className="w-1/3 bg-slate-50 p-2.5 rounded-lg text-sm border-transparent focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition-all" /></div><div><input type="url" value={manualUrl} onChange={(e) => setManualUrl(e.target.value)} placeholder="相關連結 (URL)" className="w-full bg-slate-50 p-2.5 rounded-lg text-sm border-transparent focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition-all" /></div><div><textarea value={manualNote} onChange={(e) => setManualNote(e.target.value)} placeholder="備註..." className="w-full bg-slate-50 p-2.5 rounded-lg text-sm border-transparent focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition-all resize-none min-h-[60px]" /></div></div>)}
                                <div className="pl-2 mt-2">{pendingImage ? (<div className="relative inline-block group"><img src={pendingImage} alt="Pending" className="h-16 w-auto rounded-lg border border-slate-200" /><button onClick={() => setPendingImage('')} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-sm hover:bg-red-600 transition-colors"><X size={12}/></button></div>) : (<div className="flex flex-wrap items-center gap-2"><button onClick={handleSmartPaste} className="text-blue-600 hover:text-blue-800 bg-blue-50 border border-blue-100 flex items-center gap-1 text-xs rounded-lg px-3 py-2 hover:bg-blue-100 transition-all font-medium"><ClipboardList size={14}/> 貼上全部 (文字+圖片)</button><button onClick={handlePasteFromClipboard} className="text-slate-600 hover:text-slate-800 bg-slate-50 border border-slate-200 flex items-center gap-1 text-xs rounded-lg px-3 py-2 hover:bg-slate-100 transition-all"><Clipboard size={14}/> 僅貼上圖片</button><button onClick={() => fileInputRef.current.click()} className="text-slate-500 hover:text-slate-700 bg-slate-50 border border-slate-200 flex items-center gap-1 text-xs rounded-lg px-3 py-2 hover:bg-slate-100 transition-all"><Upload size={14}/> 上傳圖片</button><input type="file" ref={fileInputRef} onChange={handleFileUpload} accept="image/*" className="hidden" /></div>)}</div>
                                <div className="flex justify-end mt-3 border-t border-slate-50 pt-3"><button onClick={handleAddTask} disabled={(inputMode === 'paste' ? !pasteVal.trim() : !manualName.trim()) && !pendingImage} className="bg-blue-600 hover:bg-blue-700 active:scale-95 disabled:bg-slate-200 disabled:text-slate-400 disabled:cursor-not-allowed text-white px-5 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg shadow-blue-200 transition-all"><Plus size={16}/> 新增項目</button></div>
                            </div>
                        )}

                        <div className="flex gap-1 mb-4 bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setViewStatus('active')} className={`flex-1 py-2 text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all ${viewStatus === 'active' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><ListTodo size={16} /> 待辦 <span className={`text-[10px] px-1.5 py-0.5 rounded-full ${viewStatus === 'active' ? 'bg-blue-100 text-blue-700' : 'bg-slate-200 text-slate-500'}`}>{tasks.filter(t => !t.completed && !t.isDeleted).length}</span></button>
                            <button onClick={() => setViewStatus('completed')} className={`flex-1 py-2 text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all ${viewStatus === 'completed' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><CheckCircle2 size={16} /> 完成 <span className={`text-[10px] px-1.5 py-0.5 rounded-full ${viewStatus === 'completed' ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-500'}`}>{tasks.filter(t => t.completed && !t.isDeleted).length}</span></button>
                            <button onClick={() => setViewStatus('deleted')} className={`flex-1 py-2 text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all ${viewStatus === 'deleted' ? 'bg-white text-red-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Trash size={16} /> 垃圾桶 <span className={`text-[10px] px-1.5 py-0.5 rounded-full ${viewStatus === 'deleted' ? 'bg-red-100 text-red-700' : 'bg-slate-200 text-slate-500'}`}>{tasks.filter(t => t.isDeleted).length}</span></button>
                        </div>

                        <div className="flex flex-col sm:flex-row gap-3 mb-4 justify-between items-center">
                            <div className="flex items-center gap-2 w-full sm:w-auto">
                                <button onClick={() => { setIsSelectionMode(!isSelectionMode); setSelectedTasks(new Set()); }} className={`px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5 transition-colors ${isSelectionMode ? 'bg-slate-800 text-white' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-50'}`}><CheckSquare size={16}/> {isSelectionMode ? '結束多選' : '多選操作'}</button>
                                {isSelectionMode && (<><button onClick={handleSelectAll} className="px-3 py-1.5 bg-white border border-slate-200 text-slate-600 rounded-lg text-sm hover:bg-slate-50">{selectedTasks.size === processedTasks.length && processedTasks.length > 0 ? '取消全選' : '全選'}</button><div className="h-4 w-px bg-slate-300 mx-1"></div>{selectedTasks.size > 0 && (<div className="flex gap-2 animate-in fade-in zoom-in duration-200">{viewStatus !== 'deleted' && (<select onChange={(e) => { if(e.target.value) handleBatchMoveTag(e.target.value); }} className="bg-indigo-50 text-indigo-700 text-sm px-2 py-1.5 rounded-lg border border-indigo-100 focus:ring-2 focus:ring-indigo-500 outline-none font-medium" value=""><option value="" disabled>移動到...</option><option value="default">未分類</option>{tags.map(t => <option key={t} value={t}>{t}</option>)}</select>)}<button onClick={handleBatchDelete} className="px-3 py-1.5 bg-red-50 border border-red-100 text-red-600 rounded-lg text-sm hover:bg-red-100 flex items-center gap-1 font-medium"><Trash size={14}/> 刪除</button></div>)}</>)}
                            </div>
                            {viewStatus === 'deleted' && !isSelectionMode && tasks.some(t => t.isDeleted) && (<button onClick={handleEmptyTrash} className="ml-auto px-3 py-1.5 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 flex items-center gap-1 shadow-sm font-medium"><Trash2 size={16}/> 清空垃圾桶</button>)}
                            {!isSelectionMode && (<div className="flex gap-2 ml-auto"><div className="flex gap-1 bg-white border border-slate-200 p-1 rounded-lg"><button onClick={() => setFilterType('all')} className={`px-2 py-1 rounded-md text-xs font-medium ${filterType === 'all' ? 'bg-slate-100 text-slate-900' : 'text-slate-400 hover:text-slate-600'}`}>全部</button><button onClick={() => setFilterType('ticket')} className={`px-2 py-1 rounded-md text-xs font-medium ${filterType === 'ticket' ? 'bg-blue-50 text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}>票券</button><button onClick={() => setFilterType('normal')} className={`px-2 py-1 rounded-md text-xs font-medium ${filterType === 'normal' ? 'bg-slate-100 text-slate-900' : 'text-slate-400 hover:text-slate-600'}`}>一般</button></div><select value={sortType} onChange={(e) => setSortType(e.target.value)} className="bg-white border border-slate-200 text-slate-600 text-xs rounded-lg p-1.5 outline-none focus:border-blue-300 font-medium"><option value="newest">最新</option><option value="expiring">快到期</option><option value="oldest">最早</option></select></div>)}
                        </div>

                        {loading ? (<div className="flex flex-col items-center justify-center py-20 opacity-50"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div><span className="text-xs text-slate-400">同步資料中...</span></div>) : (<div className="space-y-1 pb-20"><div className="flex items-center justify-between px-1 mb-2"><h2 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1">{processedTasks.length} 筆項目{isSelectionMode && <span className="text-blue-600 ml-2">(已選 {selectedTasks.size})</span>}</h2></div>{processedTasks.length === 0 ? (<div className="text-center py-16 bg-white rounded-3xl border border-dashed border-slate-200"><div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3"><ListTodo className="text-slate-300" size={32} /></div><p className="text-slate-400 font-medium">沒有符合的項目</p></div>) : (processedTasks.map(task => <TaskItem key={task.id} task={task} onToggle={handleToggleComplete} onDelete={handleDelete} onRestore={handleRestore} onPermanentDelete={handlePermanentDelete} onUpdateNote={handleUpdateNote} onUpdateText={handleUpdateText} onUpdateTicket={handleUpdateTicket} isSelectionMode={isSelectionMode} isSelected={selectedTasks.has(task.id)} onSelect={handleSelect} expiryThreshold={expiryThreshold} />))}</div>)}
                    </div>
                    
                    <TagManagerModal isOpen={showTagManager} onClose={() => setShowTagManager(false)} tags={tags} onAddTag={handleAddTag} onDeleteTag={handleDeleteTag} onRenameTag={handleRenameTag} />
                    {showMigration && <MigrationModal isOpen={showMigration} onClose={() => setShowMigration(false)} currentSpaceId={workspaceId} onMigrate={handleMigrate}/>}
                    {isMigrating && <div className="fixed inset-0 bg-white/80 z-[60] flex items-center justify-center backdrop-blur-sm"><div className="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 flex flex-col items-center gap-4"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div><p className="font-bold text-slate-700">正在搬運資料...</p></div></div>}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
